<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stack Tower ‚Äî Retro</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#05060a; --bg2:#0b0e18; --ink:#e6f7ff; --muted:#7fd0e0; --border:#00f0ff55;
    --neon1:#00f0ff; --neon2:#ff47ff; --neon3:#ffe94d; --card:#0a0d17f0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    font-family:'Press Start 2P',system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1200px 700px at 20% -10%, #1a0f3a55 0%, transparent 60%),
      radial-gradient(1100px 650px at 110% 10%, #003a4450 0%, transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    letter-spacing:.4px;
  }
  body::before,body::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:0}
  body::before{
    background:repeating-linear-gradient(to bottom,rgba(255,255,255,.06) 0,rgba(255,255,255,.06) 1px,transparent 2px,transparent 4px);
    mix-blend-mode:overlay;
  }
  body::after{background:radial-gradient(1200px 700px at 50% -10%,transparent 40%,rgba(0,0,0,.55) 100%)}
  .wrap{max-width:980px;margin:0 auto;padding:16px;position:relative;z-index:1}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:clamp(16px,3.6vw,24px);text-shadow:0 0 6px var(--neon1),0 0 12px var(--neon2)}
  .btn{border:2px solid var(--neon2);background:#000;color:#fff;border-radius:6px;padding:8px 12px;cursor:pointer;box-shadow:0 0 12px var(--neon2)}
  .panel{position:relative;border:2px solid var(--border);background:var(--card);border-radius:14px;padding:12px}
  canvas{display:block;width:100%;height:auto;border-radius:10px;border:2px solid var(--border);background:#000}
  .stats{display:flex;gap:12px;margin-top:10px;flex-wrap:wrap}
  .chip{border:2px solid var(--border);background:#0008;border-radius:999px;padding:6px 10px;font-size:10px}
  .hint{color:var(--muted);font-size:10px;margin-top:8px}
  .overlay{position:absolute;inset:12px;display:none;place-items:center;background:rgba(0,0,0,.5);border-radius:10px}
  .share{width:min(520px,90%);border:2px solid var(--border);border-radius:10px;background:#0f172acc;padding:16px;text-align:center}
  .share h2{margin:0 0 6px;font-size:22px}
  .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px}
  .ok{background:#22c55e22;border-color:#22c55e66}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üß± Stack Tower (Retro)</h1>
    <div>
      <a class="btn" href="../">‚Üê Back</a>
      <button id="resetBtn" class="btn">Reset</button>
      <button id="pauseBtn" class="btn">Pause</button>
    </div>
  </header>

  <section class="panel">
    <canvas id="cv" width="640" height="900"></canvas>

    <div id="overlay" class="overlay">
      <div class="share">
        <h2>GAME OVER</h2>
        <div class="chip">Score: <b id="finalScore">0</b></div>
        <div class="chip">Best: <b id="finalBest">0</b></div>
        <div class="chip">Perfects: <b id="finalPerfects">0</b></div>
        <div class="row" style="margin-top:12px">
          <button id="againBtn" class="btn ok">Play Again</button>
          <button id="shareBtn" class="btn">Share</button>
          <a id="tweetBtn" class="btn" href="#" target="_blank" rel="noopener">Tweet</a>
          <button id="copyBtn" class="btn">Copy Link</button>
        </div>
        <div id="shareMsg" class="hint"></div>
      </div>
    </div>

    <div class="stats">
      <div class="chip">Level: <span id="lvl">1</span></div>
      <div class="chip">Best: <span id="best">0</span></div>
      <div class="chip">Perfects: <span id="perfects">0</span></div>
    </div>
    <div class="hint">Tap / click / SPACE to drop. Align or get sliced!</div>
  </section>
</div>

<script>
/* ====== same gameplay with retro skin ====== */
const cv = document.getElementById('cv');
const cx = cv.getContext('2d');
const lvlEl = document.getElementById('lvl');
const bestEl = document.getElementById('best');
const perfEl = document.getElementById('perfects');
const overlay = document.getElementById('overlay');
const finalScoreEl = document.getElementById('finalScore');
const finalBestEl = document.getElementById('finalBest');
const finalPerfectsEl = document.getElementById('finalPerfects');
const shareBtn = document.getElementById('shareBtn');
const tweetBtn = document.getElementById('tweetBtn');
const copyBtn = document.getElementById('copyBtn');
const againBtn = document.getElementById('againBtn');
const shareMsg = document.getElementById('shareMsg');
const HS_KEY = 'stacktower.best.v1';
let best = +localStorage.getItem(HS_KEY) || 0; bestEl.textContent = best;

const W = cv.width, H = cv.height;
const BASE_HEIGHT = 26;
const START_WIDTH = Math.floor(W*0.7);
const PERFECT_TOL = 6;
const MIN_WIDTH = 12;
const COLORS = ['#00f0ff','#ff47ff','#ffe94d','#4dff7a','#22a3ff','#ff7aa8'];

let stack, cur, dir, speed, offsetY, running, paused, level, perfects;

/* SOUND */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const actx = new AudioCtx();
function beep(freq, dur=0.08, type='square', gain=0.12){
  const o = actx.createOscillator(); const g = actx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.setValueAtTime(0, actx.currentTime);
  g.gain.linearRampToValueAtTime(gain, actx.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+dur);
  o.connect(g).connect(actx.destination); o.start(); o.stop(actx.currentTime+dur);
}
const sfx = {
  drop: ()=> beep(220,0.09,'square',0.09),
  cut:  ()=> { beep(520,0.05,'triangle',0.07); beep(300,0.07,'sine',0.05); },
  perfect: ()=> { beep(660,0.06,'sine',0.07); setTimeout(()=>beep(880,0.06,'sine',0.06),60); },
  over: ()=> { beep(200,0.18,'sawtooth',0.12); setTimeout(()=>beep(120,0.22,'sawtooth',0.12),120); }
};

/* GAME */
function newGame(){
  hideOverlay(); level=1; speed=2.0; perfects=0; paused=false; running=true; offsetY=0;
  stack=[{x:(W-START_WIDTH)/2,y:H-BASE_HEIGHT,w:START_WIDTH,c:0}];
  cur={x:0,y:stack[0].y-BASE_HEIGHT,w:START_WIDTH,c:1,vx:speed}; dir=1;
  draw(); updateHUD();
}
function updateHUD(){ lvlEl.textContent=level; perfEl.textContent=perfects; bestEl.textContent=best; }
function color(i){ return COLORS[i%COLORS.length]; }
function drop(){
  if(!running){ newGame(); return; }
  if(paused){ paused=false; return; }
  const prev = stack[stack.length-1];
  const L = Math.max(prev.x,cur.x), R = Math.min(prev.x+prev.w,cur.x+cur.w), overlap = R-L;
  if(overlap<=0){
    running=false; sfx.over(); if(level-1>best){best=level-1;localStorage.setItem(HS_KEY,best);} updateHUD(); showOverlay(level-1,best,perfects); return;
  }
  const offset = Math.abs((prev.x+prev.w/2)-(cur.x+cur.w/2));
  const perfect = offset<=PERFECT_TOL;
  if(perfect){ cur.x=prev.x; cur.w=prev.w; perfects++; sfx.perfect(); }
  else{ if(overlap<cur.w) sfx.cut(); else sfx.drop(); cur.x=L; cur.w=overlap; }
  cur.c = stack[stack.length-1].c+1; stack.push({x:cur.x,y:cur.y,w:cur.w,c:cur.c});
  if(cur.w<MIN_WIDTH){ running=false; sfx.over(); if(level>best){best=level;localStorage.setItem(HS_KEY,best);} updateHUD(); showOverlay(level,best,perfects); return; }
  level++; updateHUD(); speed=Math.min(6,speed+0.05);
  const nextW=cur.w, startX=(dir>0)?-nextW:W;
  cur={x:startX,y:stack[stack.length-1].y-BASE_HEIGHT,w:nextW,c:stack[stack.length-1].c+1,vx:dir*speed}; dir*=-1;
  const topY=stack[stack.length-1].y; if(topY<H*0.35){ const shift=(H*0.35-topY); for(const b of stack) b.y+=shift; cur.y+=shift; offsetY+=shift; }
}
function togglePause(){ paused=!paused; if(!paused) last=performance.now(); }
let last=0;
function loop(t){
  requestAnimationFrame(loop);
  if(!running||paused){ draw(); return; }
  const dt = Math.min(32, t-(last||t)); last=t;
  cur.x += cur.vx*(dt/16);
  if(cur.x <= -cur.w) cur.vx = Math.abs(cur.vx);
  if(cur.x+cur.w >= W+cur.w) cur.vx = -Math.abs(cur.vx);
  draw();
}
function draw(){
  const g=cx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#070a18'); g.addColorStop(1,'#0b1430');
  cx.fillStyle=g; cx.fillRect(0,0,W,H);
  cx.strokeStyle='rgba(0,240,255,0.15)'; cx.lineWidth=1;
  for(let i=1;i<10;i++){ cx.beginPath(); cx.moveTo(0,H-i*90+(offsetY%90)); cx.lineTo(W,H-i*90+(offsetY%90)); cx.stroke(); }
  for(const b of stack) drawBlock(b.x,b.y,b.w,BASE_HEIGHT,color(b.c));
  drawBlock(cur.x,cur.y,cur.w,BASE_HEIGHT,color(cur.c));
  cx.fillStyle='#e6f7ff'; cx.font='700 18px "Press Start 2P"'; cx.fillText(`LV ${level}`,14,28);
}
function drawBlock(x,y,w,h,hex){
  const lg=cx.createLinearGradient(x,y,x+w,y+h); lg.addColorStop(0,hex); lg.addColorStop(1,'#ffffff22');
  cx.fillStyle=lg; roundRect(x,y,w,h,8); cx.fill();
  cx.fillStyle='rgba(255,255,255,0.15)'; roundRect(x+4,y+4,w-8,6,4); cx.fill();
}
function roundRect(x,y,w,h,r){ cx.beginPath(); cx.moveTo(x+r,y); cx.arcTo(x+w,y,x+w,y+h,r); cx.arcTo(x+w,y+h,x,y+h,r); cx.arcTo(x,y+h,x,y,r); cx.arcTo(x,y,x+w,y,r); cx.closePath(); }

/* SHARE */
function showOverlay(score,bestVal,perfectsVal){
  finalScoreEl.textContent=score; finalBestEl.textContent=bestVal; finalPerfectsEl.textContent=perfectsVal;
  buildShareLinks(score,bestVal,perfectsVal); overlay.style.display='grid';
}
function hideOverlay(){ overlay.style.display='none'; shareMsg.textContent=''; }
function buildShareLinks(score,bestVal,perfectsVal){
  const url = location.origin + location.pathname;
  const text = `I reached Level ${score} in Stack Tower on GameDock! üß± (Best ${bestVal}, Perfects ${perfectsVal})`;
  const tweetURL = new URL('https://twitter.com/intent/tweet'); tweetURL.searchParams.set('text',text); tweetURL.searchParams.set('url',url); tweetBtn.href=tweetURL.toString();
  shareBtn.onclick = async()=>{ try{ if(navigator.share){ await navigator.share({title:'Stack Tower ‚Äî GameDock', text, url}); } else { await navigator.clipboard.writeText(text+' '+url); shareMsg.textContent='Copied to clipboard.'; } }catch(e){ shareMsg.textContent='Share cancelled.'; } };
  copyBtn.onclick = async()=>{ try{ await navigator.clipboard.writeText(url+`?score=${score}`); shareMsg.textContent='Link copied!'; }catch{ shareMsg.textContent='Could not copy link.'; } };
  againBtn.onclick = ()=> newGame();
}

/* INPUT */
const resetBtn=document.getElementById('resetBtn'); const pauseBtn=document.getElementById('pauseBtn');
function activateAudio(){ if(actx.state==='suspended') actx.resume(); }
function onAction(e){ e&&e.preventDefault(); activateAudio(); drop(); }
window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); onAction(); } if(e.key.toLowerCase()==='p') togglePause(); if(e.key.toLowerCase()==='r') newGame(); });
cv.addEventListener('click', onAction); cv.addEventListener('touchstart', onAction, {passive:false});
resetBtn.onclick=()=>newGame(); pauseBtn.onclick=()=>togglePause();

/* START */
newGame(); requestAnimationFrame(loop);
</script>
</body>
</html>
